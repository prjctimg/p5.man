name: p5.js Types and Modules Sync

on:
  release:
    types: [published]
  schedule:
    # Run daily at 2 AM UTC to check for type updates
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: "24"

jobs:
  # Check if we need to run (for scheduled runs)
  check-updates:
    runs-on: ubuntu-latest
    name: Check for Updates
    if: github.event_name == 'schedule'
    
    permissions:
      contents: read
    
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      p5_version: ${{ steps.check.outputs.p5_version }}
      p5nvim_version: ${{ steps.check.outputs.p5nvim_version }}

    steps:
      - name: Check for new releases
        id: check
        run: |
          echo "Checking for new p5.js releases..."
          
          # Get latest p5.js release
          P5_LATEST=$(curl -s https://api.github.com/repos/processing/p5.js/releases/latest | jq -r .tag_name)
          echo "p5_latest=$P5_LATEST" >> $GITHUB_OUTPUT
          
          # Get latest p5.nvim commit (to track if we've already processed this version)
          curl -s https://api.github.com/repos/prjctimg/p5.nvim/commits/main | jq -r .sha > p5nvim_latest.txt
          
          # Simple check - if we have a new release, we should run
          if [ -n "$P5_LATEST" ]; then
            echo "Found p5.js version: $P5_LATEST"
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "p5_version=$P5_LATEST" >> $GITHUB_OUTPUT
          else
            echo "No new releases found"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # Generate types and modules
  generate-types-and-modules:
    runs-on: ubuntu-latest
    name: Generate Types and Modules

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm install

      - name: Install p5 types and @types/p5
        run: |
          echo "üì¶ Installing p5 types and @types/p5..."
          npm install @types/p5 dts-bundle

      - name: Install system dependencies for GitHub API
        run: |
          echo "üì¶ Installing system dependencies..."
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Generate types and modules
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          P5_NVIM_TOKEN: ${{ secrets.P5NVIM_PUSH_TOKEN }}
        run: |
          echo "üöÄ Starting types and modules generation..."
          ./scripts/p5/types.sh
          ./scripts/p5/assets.sh

      - name: Clone p5.nvim repository
        run: |
          echo "üì• Cloning p5.nvim repository..."
          git clone https://x-access-token:${{ secrets.P5NVIM_PUSH_TOKEN }}@github.com/prjctimg/p5.nvim.git /tmp/p5.nvim

      - name: Commit and push types and modules to p5.nvim
        run: |
          echo "üìù Committing types and modules to p5.nvim..."
          cd /tmp/p5.nvim

          # Copy generated types if they exist
          if [ -d "/home/runner/work/automata/automata/assets/types" ]; then
            mkdir -p assets/types
            cp -r /home/runner/work/automata/automata/assets/types/* assets/types/ || true
            echo "‚úÖ Copied types"
          fi

          # Copy generated modules if they exist
          if [ -d "/home/runner/work/automata/automata/assets/libs" ]; then
            mkdir -p assets/libs
            cp -r /home/runner/work/automata/automata/assets/libs/* assets/libs/ || true
            echo "‚úÖ Copied modules"
          fi

          # Configure git
          git config user.name "gh-actions"
          git config user.email "actions@github.com"

          # Debug: Check what we're copying
          echo "üîç Debugging file copy process..."
          echo "Source types directory: /home/runner/work/automata/automata/assets/types"
          echo "Destination: $(pwd)/assets/types"
          ls -la /home/runner/work/automata/automata/assets/types/ || echo "Source types directory not found"
          ls -la assets/types/ || echo "Destination types directory not found"
          
          # Force add assets directories to ensure they're tracked
          if [ -d "assets/types" ]; then
            git add -f assets/types/
            echo "‚úÖ Added assets/types to git"
          fi
          if [ -d "assets/libs" ]; then
            git add -f assets/libs/
            echo "‚úÖ Added assets/libs to git"
          fi
          
          git status
          git diff --cached --name-only
          
          # Always commit if we have assets directories
          if [ -d "assets/types" ] || [ -d "assets/libs" ]; then
            # Create a commit even if git thinks there are no changes (files might be identical)
            if [ -n "$(git diff --cached --name-only)" ]; then
              git commit -m "Update p5.js types and core modules ($(date +'%Y-%m-%d %H:%M:%S'))"
              echo "‚úÖ Committed changes"
            else
              # Force commit by touching a file to ensure there's a change
              echo "üìù Ensuring commit with timestamp..."
              echo "Updated at $(date -Iseconds)" > assets/.last_update
              git add assets/.last_update
              if [ -d "assets/types" ]; then
                git add -f assets/types/
              fi
              if [ -d "assets/libs" ]; then
                git add -f assets/libs/
              fi
              git commit -m "Update p5.js types and core modules ($(date +'%Y-%m-%d %H:%M:%S'))"
              echo "‚úÖ Forced commit completed with assets"
            fi
          else
            echo "‚ùå No assets directories found"
          fi
          
          # Pull latest changes and push
          git pull origin main --rebase || true
          git pull origin main --rebase || true
          git push origin main --force-with-lease --force-with-lease

      - name: Upload types
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p5-types
          path: assets/types/

      - name: Upload modules
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p5-modules
          path: assets/

      - name: Summary
        run: |
          echo "## Types and Modules Generation Complete üéâ" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "/home/runner/work/automata/automata/assets/types" ]; then
            echo "- ‚úÖ Generated TypeScript definitions" >> $GITHUB_STEP_SUMMARY
            echo "  - p5.d.ts (bundled p5 types in assets/types/)" >> $GITHUB_STEP_SUMMARY
            echo "  - Includes globals and p5 namespace support" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -d "/home/runner/work/automata/automata/assets" ]; then
            echo "- ‚úÖ Generated core modules" >> $GITHUB_STEP_SUMMARY
            echo "  - Non-minified p5.js modules in assets/libs/" >> $GITHUB_STEP_SUMMARY
            echo "  - Latest releases from GitHub" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- ‚úÖ Updated p5.nvim repository" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ All files are available in the artifacts" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.check-updates.outputs.p5_version }}" != "" ]; then
            echo "- üì¶ p5.js version: ${{ needs.check-updates.outputs.p5_version }}" >> $GITHUB_STEP_SUMMARY
          fi

  # Generate documentation (separate job to avoid conflicts)
  generate-docs:
    runs-on: ubuntu-latest
    name: Generate Documentation
    needs: generate-types-and-modules
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm install

      - name: Install p5 types and @types/p5
        run: |
          echo "üì¶ Installing p5 types and @types/p5..."
          npm install @types/p5 dts-bundle

      - name: Download types artifact
        uses: actions/download-artifact@v4
        with:
          name: p5-types
          path: assets/types/

      - name: Clone p5.js
        run: |
          echo "üì• Cloning p5.js repository..."
          git clone --depth 1 https://github.com/processing/p5.js.git /tmp/p5.js

      - name: Generate docs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          P5_NVIM_TOKEN: ${{ secrets.P5NVIM_PUSH_TOKEN }}
        run: |
          echo "üöÄ Starting documentation generation..."
          ./scripts/p5/docs.sh

      - name: Clone p5.nvim repository
        run: |
          echo "üì• Cloning p5.nvim repository..."
          git clone https://x-access-token:${{ secrets.P5NVIM_PUSH_TOKEN }}@github.com/prjctimg/p5.nvim.git /tmp/p5.nvim

      - name: Commit and push docs to p5.nvim
        run: |
          echo "üìù Committing documentation to p5.nvim..."
          cd /tmp/p5.nvim

          # Copy generated docs
          mkdir -p doc/
          cp -r /home/runner/work/automata/automata/doc/* doc/ || true

          # Configure git
          git config user.name "gh-actions"
          git config user.email "actions@github.com"

          # Add and commit changes
          git add doc/
          git diff --staged --quiet || git commit -m "Update p5.js documentation ($(date +'%Y-%m-%d %H:%M:%S'))"

          # Push changes
          git pull origin main --rebase || true
          git push origin main --force-with-lease

      - name: Upload docs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p5-documentation
          path: doc/